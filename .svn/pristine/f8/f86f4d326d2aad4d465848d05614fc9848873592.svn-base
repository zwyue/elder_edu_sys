<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">	
		<title>老年大学系统——档案管理</title>
		<link rel="stylesheet" href="plugins/layui-v2.4.3/layui/css/layui.css"/>
		<link rel="stylesheet" href="css/common_style.css" />
		<link rel="stylesheet" href="css/yhgl_xsgl.css" />

	</head>
	<body>
		<!--用户管理内容-->
		<div class="layui-body yhglContent">
			<span class="layui-breadcrumb yhgl_nav">
			  <a href="javascript:;"><cite>档案管理</cite></a><span lay-separator="">＞</span>
			  <a href="javascript:;">资源建设</a>
			</span>			
			<!--查询-->
			<div class="layui-form chaXun">
			  <div class="layui-form-item">
				  <div class="layui-inline">
					  <label class="layui-form-label">名称：</label>
					  <div class="layui-input-inline">
						  <input type="text" class="layui-input" id="filterName" placeholder="支持模糊查询">
					  </div>
				  </div>
				  <div class="layui-inline">
					  <label class="layui-form-label">类别：</label>
					  <div class="layui-input-inline">
						  <select id="types">
							  <option value="">请选择</option>
							  <option value="0">数字化建设</option>
							  <option value="1">教材建设</option>
						  </select>
					  </div>
				  </div>
				  <a href="javascript:;" class="btn_chaXun fr" id="chaXun" onclick="chaxun()">查询</a>
			  </div>			  
			</div>
			<!--查询 end-->
			
			<!--表格-->
			<div class="biaoGe">
				<section >
					<span class="xslb_bt fl">资源建设列表</span>
					<a href="dagl_zyjsxz.html" class="xzxs fr" id="xzxs" >
						<i class="layui-icon layui-icon-add-1"></i>新增档案
					</a>
				</section>
				<!---数据表格-->
				<table class="layui-table" lay-skin="line" id="tb">
			      <thead>
			        <tr>
			          <th>序号</th>
			          <th>名称</th>
					  <th>类别</th>
			          <th>创建时间</th>
			          <th>操作</th>			        
			        </tr> 
			      </thead>
			    <tbody id="listZyjs"></tbody>
			    </table>
				<!--数据表格 end-->
				
				<!--分页-->
				<div class="page">
					<!--<p>共50页</p>-->
					<div id="demo5"></div>					
				</div>
				<!--分页 end-->
			</div>
			<!--表格end-->
		</div>
		<!--用户管理内容 end-->

		<script src="plugins/jQuery/jquery-3.3.1.js"></script>
		<script src="plugins/layui-v2.4.3/layui/layui.js"></script>
		<!--<script src="js/dagl_zyjs.js"></script>-->
		<script>
            //from表单select 通用
            layui.use('form', function(){
                var form = layui.form;
            });
            $(function () {
                DatatoLoad();
            });
            function DatatoLoad() {
                //分页
                var pageNum = 0;    //初始化页数为第一页
                var pageSize = 7;   //列表数量为7条
                layui.use('laypage', function () {
                    var laypage = layui.laypage;
                    var totalSize = 0; //初始化数据总数
                    getDatasSize();

                    function getDatasSize() {
                        $.ajax({
                            type: 'get',
                            async: false,
                            url: "http://192.168.0.166:8080/resource/list",
                            data: {
                                page: pageNum,
                                size: pageSize
                            },
                            dataType: "json",
                            xhrFields: {withCredentials: true},
                            success: function (data) {
                                totalSize = data.data.total; //获得数据总条数
                                var html = '';
                                var len = data.data.list.length;
                                for (var i = 1; i < len + 1; i++) {
                                    $('table tr:eq(' + i + ')td:first').text(i);
                                }

                                $.each(data.data.list, function (i, result) {
                                    var categoryText;
                                    if(result.category==0){
                                        categoryText='数字化建设' ;
                                    }
                                    else if(result.category==1){
                                        categoryText='教材建设' ;
                                    }
                                    html += "<tr>";
                                    html += "<td>" + (i + 1) + "</td>" + "<td>" + result.title + "</td>" + "<td>" + categoryText + "</td>" + "<td>" + result.times + "</td>" +
                                        "<td><a href='JavaScript:;' onclick='delect(" + result.id + ")' class='bg bgActive del'>删除</a>" +
                                        "<a href='dagl_zyjsxg.html?id=" + result.id + "' class='bg change'>修改</a>" +
                                        "<a href='http://192.168.0.166:8080/resource/export?id=" + result.id + "' class='bg look'>导出</a></td>";
                                    html += "</tr>";
                                })
                                $("#listZyjs").html(html);
                            },
                            error: function () {
                                console.log("error");
                            },
                        })
                    }

                    //执行一个laypage
                    laypage.render({
                        elem: 'demo5',    //分页容器，此处是id
                        count: totalSize, //数据总数，从服务端得到
                        curr: pageNum,
                        limit: pageSize,
                        jump: function (obj, first) {
                            pageNum = obj.curr;     //得到当前页，以便向服务端请求对应页的数据。
                            pageSize = obj.limit;   //得到每页显示的条数

                            //首次不执行
                            if (!first) {
                                $("#listZyjs").empty();
                                getDatasSize();
                            }
                        }
                    })
                })
            }

            //删除
            function delect(id) {
                $.ajax({
                    type: 'get',
                    url: "http://192.168.0.166:8080/resource/delete",
                    async: false,
                    data: {
                        id: id
                    },
                    dataType: "json",
                    xhrFields: {withCredentials: true},
                    success: function (data) {
                        if (data.code == 1) {
                            layui.use('layer', function(){
                                layer.confirm('确认要删除吗？', function(index){
                                    //发异步删除数据
                                    layer.msg('已删除!', {
                                        icon: 1,
                                        time: 1000
                                    });
                                    DatatoLoad();
                                });
                            });
                        } else {
                            layui.use('layer', function () {
                                var layer = layui.layer;
                                layer.msg('删除失败！');
                            });
                        }
                        // DatatoLoad();
                    },
                    error: function () {
                        layui.use('layer', function () {
                            var layer = layui.layer;
                            layer.msg('删除失败！');
                        });
                    }
                })
            }

            //查询
            function chaxun() {
                //验证真实姓名
                var textName = $('#filterName').val();
                var type = $('#types').val();
                if (textName == '' && type == '') {
                    layui.use('layer', function () {
                        var layer = layui.layer;
                        layer.alert('请输入名称或者类别', {area: ['200px']});
                    });
                    return false;
                }
                else{
                    //分页
                    var pageNum = 0;//初始化页数为第一页
                    var pageSize = 7;
                    layui.use('laypage', function () {
                        var laypage = layui.laypage;
                        var totalRecord = 0;//初始化总记录数
                        getQuery();

                        function getQuery() {
                            $.ajax({
                                type: 'GET',
                                url: "http://192.168.0.166:8080/resource/getTitle",
                                async: false,
                                data: {
                                    title: textName,
                                    category:type,
                                    page: pageNum,
                                    size: pageSize
                                },
                                dataType: "json",
                                xhrFields: {withCredentials: true},
                                success: function (data) {
                                    if (data.data.list.length == 0) {
                                        layui.use('layer', function () {
                                            var layer = layui.layer;
                                            layer.alert('该学生未查到相关信息', {area: ['200px']});
                                        });
                                        $("#listZyjs").html('');
                                        return false;
                                    }
                                    else {
                                        totalRecord = data.data.total;
                                        var chaXun;
                                        var len = data.data.list.length;
                                        for (var i = 1; i < len + 1; i++) {
                                            $('table tr:eq(' + i + ')td:first').text(i);
                                        }
                                        $.each(data.data.list, function (i, result) {
                                            var categoryText;
                                            if(result.category==0){
                                                categoryText='数字化建设' ;
                                            }
                                            else if(result.category==1){
                                                categoryText='教材建设' ;
                                            }
                                            chaXun += "<tr>";
                                            chaXun += "<td>" + (i + 1) + "</td>" + "<td>" + result.title + "</td>" + "<td>" + categoryText + "</td>" + "<td>" + result.times + "</td>" +
                                                "<td><a href='JavaScript:;' onclick='delect(" + result.id + ")' class='bg bgActive del'>删除</a>" +
                                                "<a href='dagl_zyjsxg.html?id=" + result.id + "' class='bg change'>修改</a>" +
                                                "<a href='http://192.168.0.166:8080/resource/export?id=" + result.id + "' class='bg look'>导出</a></td>";
                                            chaXun += "</tr>";
                                        })
                                        $("#listZyjs").html(chaXun);
                                    }
                                },
                                error: function () {
                                    layui.use('layer', function () {
                                        var layer = layui.layer;
                                        layer.msg('查询失败！');
                                    });
                                }
                            })
                            //执行一个laypage实例
                            laypage.render({
                                elem: 'demo5' //注意，这里的 test1 是 ID，不用加 #号
                                , count: totalRecord //数据总数，从服务端得到
                                , curr: pageNum
                                , limit: pageSize
                                , jump: function (obj, first) {
                                    //obj包含了当前分页的所有参数，比如：
                                    pageNum = obj.curr;//得到当前页，以便向服务端请求对应页的数据。
                                    pageSize = obj.limit;//得到每页显示的条数

                                    //首次不执行
                                    if (!first) {
                                        //do something
                                        $('#listZyjs').empty();
                                        getQuery();
                                    }
                                }
                            });
                        }
                    })
                }
            }
		</script>
	</body>
</html>
